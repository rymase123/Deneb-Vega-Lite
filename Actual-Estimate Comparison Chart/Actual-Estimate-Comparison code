{
  "data": {
    "name": "dataset"
  },
  "transform": [
    {
      "calculate": " datum['4 Week Difference'] ",
      "as": "abs_diff"
    },
    {
      "calculate": "datum['4 Week % Difference'] ",
      "as": "rel_diff"
    },
    {
      "calculate": "datum['4 Week Estimate']",
      "as": "est_text"
    }
  ],
  "vconcat": [
    {
      "width": 900,
      "height": 150,
      "encoding": {
        "x": {
          "field": "Date",
          "type": "nominal",
          "axis": null
        },
        "y": {
          "field": "4 Week % Difference",
          "type": "quantitative",
          "axis": {
            "orient": "left",
            "offset": 10,
            "format": "0%",
            "title": null,
            "labels": false,
            "titlePadding": -10,
            "gridOpacity": 1,
            "gridColor": {
              "condition": {
                "test": "datum.value == 0",
                "value": "black"
              },
              "value": "white"
            }
          }
        },
        "color": {
          "condition": [
            {
              "test": "datum.rel_diff < 0",
              "value": "red"
            },
            {
              "test": "datum.rel_diff == 0",
              "value": null
            }
          ],
          "value": "darkgreen"
        }
      },
      "layer": [
        {
          "mark": {
            "type": "point",
            "filled": true,
            "size": 100,
            "tooltip": true,
            "opacity": 1
          }
        },
        {
          "mark": {
            "type": "rect",
            "width": 1.5
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "center",
            "size": 13,
            "tooltip": true,
            "baseline": {
              "expr": "datum.rel_diff < 0 ? 'top' : 'bottom'"
            },
            "dy": {
              "expr": "datum.rel_diff < 0 ? 10 : -10"
            }
          },
          "encoding": {
            "text": {
              "field": "4 Week % Difference",
              "type": "quantitative",
              "format": "0.1%"
            },
            "color": {
              "condition": {
                "test": "datum.rel_diff == 0",
                "value": null
              },
              "value": "gray"
            }
            /*},
            "color": {
              "value": "gray" */
          }
        }
      ]
    },
    {
      "width": 900,
      "height": 150,
      "encoding": {
        "y": {
          "field": "4 Week Difference",
          "type": "quantitative",
          "axis": {
            "orient": "left",
            "offset": 10,
            "format": ".2s",
            "title": null,
            "labels": false,
            "gridOpacity": 1,
            "gridColor": {
              "condition": {
                "test": "datum.value == 0",
                "value": "black"
              },
              "value": "white"
            }
          }
        },
        "x": {
          "field": "Date",
          "type": "nominal",
          "timeUnit": "yearmonthdate",
          "axis": null
        },
        "color": {
          "condition": {
            "test": "datum.abs_diff < 0",
            "value": "red"
          },
          "value": "darkgreen"
        }
      },
      "layer": [
        {
          "mark": {
            "type": "bar",
            "tooltip": true,
            "width": 20
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "center",
            "size": 13,
            "baseline": {
              "expr": "datum.abs_diff < 0 ? 'top' : 'bottom'"
            },
            "dy": {
              "expr": "datum.abs_diff < 0 ? 5 : -5"
            }
          },
          "encoding": {
            "text": {
              "field": "4 Week Difference",
              "type": "quantitative",
              "format": ".2s"
            },
            "color": {
              "condition": {
                "test": "datum.rel_diff == 0",
                "value": null
              },
              "value": "gray"
            }
          }
        }
      ]
    },
    {
      "width": 900,
      "height": 200,
      "layer": [
        {
          "mark": {
            "type": "bar",
            "tooltip": true,
            "xOffset": 10,
            "width": {
              "band": 0.5
            },
            "color": "grey",
            "opacity": 0.4,
            "cornerRadiusTopLeft": 4,
            "cornerRadiusTopRight": 4
          },
          "encoding": {
            "y": {
              "field": "4 Week Estimate",
              "type": "quantitative"
            }
          }
        },
        {
          "mark": {
            "type": "text",
            "size": 12,
            "xOffset": 10,
            "yOffset": 5,
            "align": "right",
            "angle": -90,
            "color": {
              "expr": "datum.abs_diff === 0 ? 'black' : null"
            }
          },
          "encoding": {
            "text": {
              "field": "4 Week Estimate",
              "format": ".2s"
            },
            "y": {
              "field": "4 Week Estimate",
              "type": "quantitative"
            }
          }
        },
        {
          "mark": {
            "type": "bar",
            "tooltip": true,
            "xOffset": 0,
            "width": {
              "band": 0.5
            },
            "color": "black",
            "opacity": 1,
            "cornerRadiusTopLeft": 4,
            "cornerRadiusTopRight": 4
          },
          "encoding": {
            "y": {
              "field": "4 Week Actual",
              "type": "quantitative",
              "axis": {
                "gridOpacity": 1,
                "gridColor": {
                  "condition": {
                    "test": "datum.value == 0",
                    "value": "black"
                  },
                  "value": "white"
                },
                "orient": "left",
                "format": ".2s",
                "title": null,
                "labels": false,
                "offset": 10
              }
            }
          }
        },
        {
          "mark": {
            "type": "text",
            "size": 12,
            "xOffset": 0,
            "yOffset": 5,
            "align": "right",
            "angle": -90,
            "color": "white"
          },
          "encoding": {
            "text": {
              "field": "4 Week Actual",
              "format": ".2s"
            },
            "y": {
              "field": "4 Week Actual",
              "type": "quantitative"
            }
          }
        }
      ],
      "encoding": {
        "x": {
          "field": "Date",
          "type": "nominal",
          "timeUnit": "yearmonthdate",
          "axis": {
            "title": null,
            "labels": true,
            "labelLimit": 150,
            "labelFontSize": 12,
            "format": "%b-%d",
            "labelAngle": -30,
            "gridOpacity": 1,
            "gridColor": {
              "condition": {
                "test": "datum.value == 0",
                "value": "black"
              },
              "value": "white"
            }
          }
        }
      }
    }
  ],
  "config": {
    "style": {
      "cell": {
        "stroke": "transparent"
      }
    }
  }
}
